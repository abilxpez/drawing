<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Art Prompt Picker — MVP</title>
  <meta name="description" content="Pick a random drawing topic, track completion, and filter/search. MVP built for GitHub Pages.">
  <style>
    /* ===== Theme: olive + tan minimal ===== */
    :root{
      --bg: #f4f7f4;          /* light tan */
      --card: #ffffff;        /* paper */
      --ink: #1e2b22;         /* deep brownish */
      --sub: #5a6b5f;         /* muted text */
      --olive: #2f6f4e;       /* pastel olive */
      --olive-600:#2a6347;
      --olive-700:#22533b;
      --line: #dce7df;
      --chip: #eaf5ee;
      --chip2: #dff0e7;
      --danger:#b04a3a;
      --muted:#7a887e;
      --shadow: 0 8px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--ink);
    }
    a{color:inherit}

    .wrap{max-width:1100px; margin:0 auto; padding:28px 16px 64px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:18px}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(145deg, var(--olive), #c9c2ad); display:grid; place-items:center; color:white; font-weight:800; box-shadow:var(--shadow)}
    h1{font-size:1.25rem; margin:0}

    .grid{display:grid; grid-template-columns: 1fr; gap:18px}

    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow)}
    .pad{padding:16px}
    .title{font-weight:700; font-size:1rem; margin:0 0 10px 0}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:end}
    label{font-size:.8rem; color:var(--sub)}
    input[type="text"], select{
      border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff; min-width:160px;
    }
    .btn{border:1px solid var(--olive); background:var(--olive); color:#fff; padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn:hover{background:var(--olive-600); border-color:var(--olive-600)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent; color:var(--olive-700); border-color:var(--olive)}
    .btn.warn{background:transparent; color:var(--danger); border-color:var(--danger)}

    .result{display:grid; gap:8px; place-items:center; text-align:center; padding:18px; border:1px dashed var(--line); border-radius:14px; background:#eef7f1}
    .result .big{font-size:1.8rem; font-weight:800}
    .result .meta{font-size:.9rem; color:var(--sub)}

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{padding:6px 10px; background:var(--chip); border:1px solid var(--line); border-radius:999px; font-weight:600; font-size:.85rem}
    .chip.done{background:#dfe9d0; border-color:#c7d7ae}

    .list{display:grid; gap:10px}
    .list .head{font-size:.8rem; color:var(--sub)}
    .row{padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; display:grid; gap:8px}
    .row-title{display:flex; align-items:center; gap:10px; font-weight:600}
    .row-meta{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .cell{padding:10px 12px; background:#fff; border:1px solid var(--line); border-radius:12px}
    .cell.title{display:flex; gap:10px; align-items:center}
    .badge{font-size:.72rem; background:var(--chip2); padding:4px 8px; border-radius:999px; border:1px solid var(--line)}
    .toggle{display:inline-flex; align-items:center; gap:8px}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:end}
    .muted{color:var(--muted)}

    .stats{display:flex; gap:12px; flex-wrap:wrap}
    .stat{background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px 12px; min-width:140px}
    .stat .n{font-size:1.2rem; font-weight:800}

    .foot{margin-top:14px; font-size:.85rem; color:var(--sub)}
    .hidden{display:none !important}
    .hr{height:1px; background:var(--line); margin:12px 0}

    .uploader{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .uploader input[type=file]{border:1px dashed var(--line); background:#fff; padding:8px 10px; border-radius:10px}
    .linklike{border:none; background:transparent; color:var(--olive-700); text-decoration:underline; cursor:pointer}

    .progressBar{height:8px; background:#e4efe8; border-radius:999px; overflow:hidden} border-radius:999px; overflow:hidden}
    .progressBar > div{height:100%; background:var(--olive); width:0%}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">✦</div>
        <div>
          <h1>Art Prompt Picker</h1>
          <div class="muted">Pick a random drawing topic • mark done • search & filter</div>
        </div>
      </div>
      <div class="uploader">
        <input id="fileInput" type="file" accept=".csv,.tsv,.txt,.json" />
        <button class="btn secondary" id="btnExport">Export JSON</button>
        <button class="btn warn" id="btnReset">Reset Data</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Picker + Stats -->
      <section class="card pad">
        <h2 class="title">Random Picker</h2>
        <div class="controls" style="margin-bottom:10px">
          <button class="btn" id="btnPick">Pick Drawing</button>
          <label class="toggle"><input type="checkbox" id="onlyUndone" checked> Only pick from not completed</label>
        </div>
        <div class="result" id="resultBox">
          <div class="big" id="pickedTitle">—</div>
          <div class="meta" id="pickedMeta">Click “Pick Drawing” to start</div>
          <div class="chips" id="pickedChips"></div>
          <div>
            <button class="btn secondary hidden" id="markDoneBtn">Mark as Done</button>
            <button class="btn secondary hidden" id="markUndoneBtn">Mark as Not Done</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="stats">
          <div class="stat"><div class="n" id="statTotal">0</div><div class="muted">Total topics</div></div>
          <div class="stat"><div class="n" id="statDone">0</div><div class="muted">Completed</div></div>
          <div class="stat"><div class="n" id="statLeft">0</div><div class="muted">Remaining</div></div>
          <div class="stat"><div class="n" id="statStreak">0</div><div class="muted">Day streak</div></div>
        </div>
        <div class="foot">Progress</div>
        <div class="progressBar"><div id="progressFill"></div></div>
      </section>

      <!-- RIGHT: Filters + List -->
      <section class="card pad">
        <h2 class="title">Topics</h2>
        <div class="toolbar" style="margin-bottom:10px">
          <div>
            <label>Search</label><br>
            <input type="text" id="search" placeholder="e.g., portrait" />
          </div>
          <div>
            <label>Status</label><br>
            <select id="status">
              <option value="all">All</option>
              <option value="undone" selected>Not completed</option>
              <option value="done">Completed</option>
            </select>
          </div>
          <div>
            <label>Category</label><br>
            <select id="category">
              <option value="all">All</option>
            </select>
          </div>
          <div style="margin-left:auto">
            <button class="btn secondary" id="btnShuffle">Shuffle list</button>
          </div>
        </div>

        <div class="list" id="topicList"></div>
      </section>
    </div>

    <div class="foot" style="margin-top:16px">
      Tip: Import your spreadsheet as CSV (columns = categories). Each non-empty cell becomes a topic under that column's category. Your data is saved locally in this browser. You can export/import JSON anytime.
      <button class="linklike" id="btnDemo">Load demo data</button>
    </div>
  </div>

  <script>
    // ====== Data Layer (localStorage for MVP, backend-ready shape) ======
    /** Topic model
     * { id: string, title: string, category: string, done: boolean, doneAt?: string }
     */
    const LS_KEY = 'art_prompt_picker_v1';

    /** @type {{ topics: any[], history: string[] }} */
    let state = loadState() || { topics: [], history: [] }; // history holds ISO dates when at least one topic was marked done that day

    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||''); }catch{return null} }

    // ====== Utils ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function uid(){ return Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4) }
    function todayISO(d=new Date()){ d.setHours(0,0,0,0); return d.toISOString().slice(0,10) }
    function clamp(n,min,max){return Math.max(min,Math.min(max,n))}

    // CSV/TSV parser that handles quotes
    function parseDelimited(text){
      // Strip BOM if present
      if(text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      // Choose delimiter by sniffing first non-empty line
      const firstLine = (text.split(/
|
|
/).find(l=>l.trim().length>0) || '');
      const counts = {
        ',': (firstLine.match(/,/g)||[]).length,
        '	': (firstLine.match(/	/g)||[]).length,
        ';': (firstLine.match(/;/g)||[]).length,
      };
      let delim = ','; let max = counts[','];
      for(const k of ['	',';']){ if(counts[k] > max){ max = counts[k]; delim = k; } }
      // Robust CSV/TSV parser with quotes
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      while(i < text.length){
        const c = text[i];
        if(c === '"'){
          if(inQuotes && text[i+1] === '"'){ field += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if(c === delim && !inQuotes){
          row.push(field); field='';
        } else if((c === '
' || c === '
') && !inQuotes){
          if(field!=='' || row.length){ row.push(field); rows.push(row); row=[]; field=''; }
          // swallow CRLF pairs
          if(c === '
' && text[i+1] === '
') i++;
        } else {
          field += c;
        }
        i++;
      }
      if(field!=='' || row.length){ row.push(field); rows.push(row); }
      // Remove trailing empty rows
      while(rows.length && rows[rows.length-1].every(x=>x==='')) rows.pop();
      return rows;
    } else if((c === delim && !inQuotes)){
          row.push(field); field='';
        } else if((c === '\n' || c === '\r') && !inQuotes){
          if(field!=='' || row.length){ row.push(field); rows.push(row); row=[]; field=''; }
        } else { field += c; }
        i++;
      }
      if(field!=='' || row.length){ row.push(field); rows.push(row); }
      // Trim trailing empty lines
      while(rows.length && rows[rows.length-1].every(x=>x==='')) rows.pop();
      return rows;
    }

    // Flatten spreadsheet columns => topics
    function topicsFromTable(table){
      // First row = headers (categories). If missing, auto-name as Col1, Col2...
      const headers = (table[0]||[]).map((h,i)=> (h||'').trim() || `Col${i+1}`);
      const dataRows = table.slice(1);
      const topics = [];
      dataRows.forEach(r => {
        headers.forEach((cat, idx) => {
          const cell = (r[idx]||'').trim();
          if(cell){ topics.push({ id: uid(), title: cell, category: cat, done:false }); }
        });
      });
      return topics;
    }

    // ====== Picker / Filters ======
    const elTopicList = $('#topicList');
    const elCategory = $('#category');
    const elStatus = $('#status');
    const elSearch = $('#search');
    const elOnlyUndone = $('#onlyUndone');

    function computeCategories(){
      const cats = [...new Set(state.topics.map(t=>t.category))].sort();
      elCategory.innerHTML = '<option value="all">All</option>' + cats.map(c=>`<option>${escapeHTML(c)}</option>`).join('');
    }

    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

    function filterTopics(){
      const q = elSearch.value.trim().toLowerCase();
      const status = elStatus.value; // all|undone|done
      const cat = elCategory.value; // All or name
      return state.topics.filter(t => {
        if(status==='done' && !t.done) return false;
        if(status==='undone' && t.done) return false;
        if(cat!=='all' && t.category!==cat) return false;
        if(q && !(`${t.title} ${t.category}`.toLowerCase().includes(q))) return false;
        return true;
      });
    }

    function renderList(){
      const items = filterTopics();
      const list = document.getElementById('topicList');
      list.innerHTML = '';
      items.forEach(t => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="row-title">
            <span class="${t.done? 'chip done':'chip'}" title="${t.done? 'Completed':'Not completed'}">${t.done? 'Done':'Todo'}</span>
            <span>${escapeHTML(t.title)}</span>
          </div>
          <div class="row-meta">
            <span class="badge">${escapeHTML(t.category)}</span>
            <button class="btn secondary">${t.done? 'Mark Not Done' : 'Mark Done'}</button>
          </div>
        `;
        row.querySelector('button').addEventListener('click', ()=> { setDone(t.id, !t.done, true); });
        list.appendChild(row);
      });
    });
    }

    function updateStats(){
      const total = state.topics.length;
      const done = state.topics.filter(t=>t.done).length;
      const left = total - done;
      $('#statTotal').textContent = total;
      $('#statDone').textContent = done;
      $('#statLeft').textContent = left;
      const pct = total? Math.round((done/total)*100) : 0;
      $('#progressFill').style.width = pct + '%';
      // streak
      $('#statStreak').textContent = computeStreak(state.history);
    }

    function computeStreak(history){
      // history is array of ISO YYYY-MM-DD strings (unique days with any completion)
      const set = new Set(history);
      let streak = 0;
      for(let d = new Date(); ; d.setDate(d.getDate()-1)){
        const key = todayISO(new Date(d));
        if(set.has(key)) streak++; else break;
        // guard
        if(streak>10000) break;
      }
      return streak;
    }

    function setDone(id, done, addHistory){
      const t = state.topics.find(x=>x.id===id);
      if(!t) return;
      t.done = done;
      t.doneAt = done ? new Date().toISOString() : undefined;
      if(done && addHistory){
        const day = todayISO();
        if(!state.history.includes(day)) state.history.push(day);
      }
      saveState();
      renderList();
      updateStats();
      // if this was the currently picked item, update UI
      if(currentPick && currentPick.id===id){ renderPicked(currentPick); }
    }

    function shuffleInPlace(arr){
      for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }

    // ====== Picker ======
    let currentPick = null;
    function pickOne(){
      const pool = (elOnlyUndone.checked)
        ? state.topics.filter(t=>!t.done)
        : state.topics.slice();
      if(pool.length===0){
        renderPicked(null, 'No topics match your criteria.');
        return;
      }
      // Unbiased selection
      const idx = cryptoRandomInt(0, pool.length-1);
      currentPick = pool[idx];
      renderPicked(currentPick);
    }

    function cryptoRandomInt(min, max){
      const span = (max - min + 1) >>> 0;
      const range = span;
      const maxUnbiased = Math.floor(0x100000000 / range) * range;
      const buf = new Uint32Array(1);
      let x;
      do{ crypto.getRandomValues(buf); x = buf[0]; } while(x >= maxUnbiased);
      return min + (x % range);
    }

    function renderPicked(t, emptyMsg){
      const ttl = $('#pickedTitle');
      const meta = $('#pickedMeta');
      const chips = $('#pickedChips');
      const doneBtn = $('#markDoneBtn');
      const undoBtn = $('#markUndoneBtn');
      if(!t){
        ttl.textContent = '—';
        meta.textContent = emptyMsg || 'No pick yet';
        chips.innerHTML = '';
        doneBtn.classList.add('hidden');
        undoBtn.classList.add('hidden');
        return;
      }
      ttl.textContent = t.title;
      meta.textContent = `Category: ${t.category}` + (t.done && t.doneAt ? ` • Done: ${new Date(t.doneAt).toLocaleDateString()}` : '');
      chips.innerHTML = `<span class="${t.done? 'chip done':'chip'}">${t.done? 'Done':'Todo'}</span>`;
      doneBtn.classList.toggle('hidden', t.done);
      undoBtn.classList.toggle('hidden', !t.done);
      doneBtn.onclick = ()=> setDone(t.id, true, true);
      undoBtn.onclick = ()=> setDone(t.id, false, false);
    }

    // ====== Import / Export / Demo ======
    $('#fileInput').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const text = await f.text();
      if(f.name.endsWith('.json')){
        try{ const obj = JSON.parse(text); if(obj && Array.isArray(obj.topics)){ state = obj; saveState(); bootstrap(); return; } }catch{}
        alert('JSON import failed: file must be an exported state {topics, history}'); return;
      }
      const rows = parseDelimited(text);
      if(!rows.length){ alert('No rows found. Make sure your file has at least one header row and one row of topics.'); return; }
      const topics = topicsFromTable(rows);
      if(!topics.length){
        const preview = rows.slice(0,3).map(r=>r.join(' | ')).join('
');
        alert('No topics detected.

Quick checks:
• Is the first row your category names?
• Are there non-empty cells under them?

File preview:
' + preview);
        return; }
      state.topics = mergeUniqueTopics(state.topics, topics);
      saveState();
      bootstrap();
    });

    function mergeUniqueTopics(existing, incoming){
      const seen = new Set(existing.map(t=> `${t.title}|${t.category}`.toLowerCase()));
      const out = existing.slice();
      incoming.forEach(t=>{
        const key = `${t.title}|${t.category}`.toLowerCase();
        if(!seen.has(key)){ out.push(t); seen.add(key); }
      });
      return out;
    }

    $('#btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'art_prompt_state.json'; a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#btnReset').addEventListener('click', ()=>{
      if(!confirm('Reset local data? This will clear all topics and history on this device.')) return;
      state = { topics: [], history: [] }; saveState(); bootstrap();
    });

    $('#btnDemo').addEventListener('click', ()=>{
      if(state.topics.length && !confirm('Append demo topics to your current list?')) return;
      const demoCSV = `Nature,Portrait,Perspective\nTree silhouette,Self-portrait in 10 lines,One-point city street\nMushroom cluster,Friend in profile,Interior with window\nOcean wave,Hands holding fruit,Staircase from below`;
      const topics = topicsFromTable(parseDelimited(demoCSV));
      state.topics = mergeUniqueTopics(state.topics, topics);
      saveState(); bootstrap();
    });

    // ====== Events ======
    $('#btnPick').addEventListener('click', pickOne);
    $('#btnShuffle').addEventListener('click', ()=>{ state.topics = shuffleInPlace(state.topics); saveState(); renderList(); });
    [elSearch, elStatus, elCategory].forEach(el=>{
      el.addEventListener('input', ()=>{ renderList(); });
      el.addEventListener('change', ()=>{ renderList(); });
    });

    // ====== Bootstrap ======
    function bootstrap(){
      computeCategories();
      renderList();
      updateStats();
      renderPicked(currentPick); // refresh status chips/buttons
    }

    // First run
    bootstrap();
  </script>
</body>
</html>
